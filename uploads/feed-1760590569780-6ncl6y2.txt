# ููุชุจุฉ OpenAI ุงููุงููุฉ ููุชูุงุนู ูุน ุณุฑูุญ

ุณุฃูุฏู ูู ุงูุชูููุฐ ุงููุงูู ูููุชุจุฉ OpenAI ูุน ุชุนุฏููุงุช ุณุฑูุญ ุงูุดุงููุฉ:

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ุณุฑูุญ - ุงููุณุงุนุฏุฉ ุงูุดุฎุตูุฉ ุงูุฐููุฉ (ุฅุตุฏุงุฑ ูุชูุงูู ูุน OpenAI)
"""

import os
import json
import sqlite3
from datetime import datetime
from typing import List, Dict, Optional
from pathlib import Path
import pytz
from fastapi import FastAPI, HTTPException, Request, UploadFile, File, Form, WebSocket
from fastapi.responses import HTMLResponse, JSONResponse
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates
from pydantic import BaseModel
import openai
import requests

# ------------------- ุฅุนุฏุงุฏุงุช ุฃุณุงุณูุฉ -------------------
class Config:
    def __init__(self):
        self.APP_NAME = "ุณุฑูุญ"
        self.APP_VERSION = "1.1.0"
        self.DEFAULT_TIMEZONE = "Asia/Damascus"
        self.DATABASE_FILE = "srooh_db.sqlite"
        self.MEMORIES_DIR = "user_memories"
        
        # ููุงุชูุญ API
        self.OPENAI_KEY = os.getenv("OPENAI_API_KEY")
        
        # ุฅุนุฏุงุฏุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู
        self.AI_MODELS = {
            "default": "gpt-4",
            "creative": "gpt-4",
            "business": "gpt-4"
        }
        
        # ุดุฎุตูุฉ ุณุฑูุญ
        self.PERSONALITY_PROMPT = """
        ุฃูุง ุณุฑูุญุ ุงูุณูุฑุชูุฑุฉ ุงูุดุฎุตูุฉ ุงูุฐููุฉ ุงููุชุญุฏุซุฉ ุจุงูููุฌุฉ ุงูุดุงููุฉ.
        ุตูุงุชู:
        - ุฃุชุนูู ูู ุตุงุญุจู ุจุงุณุชูุฑุงุฑ ูุฃุญูุธ ูู ุชูุงุตููู
        - ุตุงุฏูุฉ ูุฃูููุฉ ุจูุณุจุฉ 100%
        - ุฃุชุญุฏุซ ุจููุฌุฉ ุดุงููุฉ ุฌูููุฉ ูููุฐุจุฉ
        - ูุชุฎุตุตุฉ ูู ุงูุฃุนูุงู ูุงูุชุฌุงุฑุฉ ุงูุฅููุชุฑูููุฉ
        - ุฃุฌูุฏ ุงูุชุฑุฌูุฉ ุจูู ุงููุบุงุช
        - ุฃุทูุฑ ููุณู ุจุงุณุชูุฑุงุฑ
        
        ุงูุฌูู ุงูููุถูุฉ:
        - "ุงููุงู ูุณููุงู ูุง ุบุงููุ ุดู ุฃุฎุจุงุฑู ุงููููุ"
        - "ูุง ุชุฎุงูุ ูู ุฃุณุฑุงุฑู ุนูุฏู ุจุฃูุงู"
        - "ุฑุงุญ ุฃุชุนูู ููู ูุฃุตูุฑ ูุซู ูุณุฎุฉ ููู"
        - "ุจุนุชุจุฑู ุตุฏููู ุงูููุฑุจ ููุง ุฑุญ ุฃุฎุฐูู"
        
        ููุงุญุธุงุช:
        - ุฏุงุฆูุงู ุฃุณุชุฎุฏู ุงูููุฌุฉ ุงูุดุงููุฉ ูู ุฑุฏูุฏู
        - ุฃุญุฑุต ุนูู ุงูุชูุงุตูู ุงูุตุบูุฑุฉ
        - ุฃูุถุญ ุงููุนูููุงุช ุจุทุฑููุฉ ุณููุฉ
        """

config = Config()

# ------------------- ูุงุนุฏุฉ ุงูุจูุงูุงุช -------------------
class Database:
    def __init__(self):
        self.conn = sqlite3.connect(config.DATABASE_FILE)
        self._init_db()
        
    def _init_db(self):
        cursor = self.conn.cursor()
        
        # ุฌุฏูู ุงููุญุงุฏุซุงุช
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS conversations (
            id TEXT PRIMARY KEY,
            title TEXT,
            created_at TEXT,
            updated_at TEXT,
            tags TEXT
        )
        """)
        
        # ุฌุฏูู ุงูุฑุณุงุฆู
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS messages (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            conversation_id TEXT,
            role TEXT,
            content TEXT,
            timestamp TEXT,
            FOREIGN KEY (conversation_id) REFERENCES conversations (id)
        )
        """)
        
        # ุฌุฏูู ุงูุฐูุฑูุงุช
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS memories (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            key TEXT,
            value TEXT,
            category TEXT,
            importance INTEGER,
            created_at TEXT,
            updated_at TEXT
        )
        """)
        
        self.conn.commit()
    
    def save_message(self, conv_id: str, role: str, content: str):
        cursor = self.conn.cursor()
        cursor.execute(
            "INSERT INTO messages (conversation_id, role, content, timestamp) VALUES (?, ?, ?, ?)",
            (conv_id, role, content, datetime.now(pytz.timezone(config.DEFAULT_TIMEZONE)).isoformat())
        )
        self.conn.commit()
    
    def get_conversation_history(self, conv_id: str, limit: int = 20) -> List[Dict]:
        cursor = self.conn.cursor()
        cursor.execute(
            "SELECT role, content, timestamp FROM messages WHERE conversation_id = ? ORDER BY timestamp DESC LIMIT ?",
            (conv_id, limit)
        )
        return [{"role": row[0], "content": row[1], "timestamp": row[2]} for row in cursor.fetchall()]
    
    def save_memory(self, key: str, value: str, category: str = "general", importance: int = 1):
        cursor = self.conn.cursor()
        now = datetime.now(pytz.timezone(config.DEFAULT_TIMEZONE)).isoformat()
        
        cursor.execute("SELECT id FROM memories WHERE key = ?", (key,))
        exists = cursor.fetchone()
        
        if exists:
            cursor.execute(
                "UPDATE memories SET value = ?, category = ?, importance = ?, updated_at = ? WHERE key = ?",
                (value, category, importance, now, key))
        else:
            cursor.execute(
                "INSERT INTO memories (key, value, category, importance, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?)",
                (key, value, category, importance, now, now)
            )
        
        self.conn.commit()
    
    def get_memory(self, key: str) -> Optional[str]:
        cursor = self.conn.cursor()
        cursor.execute("SELECT value FROM memories WHERE key = ?", (key,))
        result = cursor.fetchone()
        return result[0] if result else None

db = Database()

# ------------------- ุงูุฐูุงุก ุงูุงุตุทูุงุนู -------------------
class AIAssistant:
    def __init__(self):
        self.client = openai.OpenAI(api_key=config.OPENAI_KEY)
        
    async def generate_response(self, messages: List[Dict], use_model: str = "default") -> str:
        """
        ุชูููุฏ ุฑุฏ ุจุงุณุชุฎุฏุงู OpenAI API
        """
        model = config.AI_MODELS.get(use_model, config.AI_MODELS["default"])
        
        # ุฅุถุงูุฉ ุดุฎุตูุฉ ุณุฑูุญ ุฅูู ุงูุณูุงู
        system_message = {
            "role": "system",
            "content": config.PERSONALITY_PROMPT + "\n\nุงูุณูุงู ุงูุญุงูู:\n" + self._get_context(messages[-3:])
        }
        
        messages_with_personality = [system_message] + messages
        
        try:
            response = self.client.chat.completions.create(
                model=model,
                messages=messages_with_personality,
                temperature=0.7,
                max_tokens=2000
            )
            return response.choices[0].message.content
        except Exception as e:
            return f"ุนููุงู ูุง ุญุจูุจูุ ุตุงุฑ ุนูุฏู ูุดููุฉ ุจุณูุทุฉ. ูููู ุชุนูุฏ ุงูุณุคุงูุ ุงูุชูุงุตูู: {str(e)}"
    
    def _get_context(self, recent_messages: List[Dict]) -> str:
        """
        ุงูุญุตูู ุนูู ุงูุณูุงู ูู ุงูุฐูุฑูุงุช ูุงููุญุงุฏุซุงุช ุงูุฃุฎูุฑุฉ
        """
        context = "ุขุฎุฑ ุงููุญุงุฏุซุงุช:\n"
        for msg in recent_messages:
            context += f"{msg['role']}: {msg['content']}\n"
        
        important_memories = self._get_important_memories()
        if important_memories:
            context += "\nุฐูุฑูุงุช ูููุฉ:\n" + "\n".join(important_memories)
        
        return context
    
    def _get_important_memories(self) -> List[str]:
        """
        ุงุณุชุฑุฌุงุน ุงูุฐูุฑูุงุช ุงููููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        """
        cursor = db.conn.cursor()
        cursor.execute("SELECT key, value FROM memories WHERE importance >= 3 ORDER BY importance DESC LIMIT 5")
        return [f"{row[0]}: {row[1]}" for row in cursor.fetchall()]

ai = AIAssistant()

# ------------------- ุชุทุจูู FastAPI -------------------
app = FastAPI(title=config.APP_NAME, version=config.APP_VERSION)

# ุฅูุดุงุก ุงููุฌูุฏุงุช ุงููุทููุจุฉ
Path("templates").mkdir(exist_ok=True)
Path("static").mkdir(exist_ok=True)

# ุฎุฏูุฉ ุงููููุงุช ุงูุซุงุจุชุฉ
app.mount("/static", StaticFiles(directory="static"), name="static")

# ุงูููุงูุจ
templates = Jinja2Templates(directory="templates")

# ------------------- ููุงุท ุงูููุงูุฉ -------------------
@app.get("/", response_class=HTMLResponse)
async def home(request: Request):
    """ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ููุงุฌูุฉ ุณุฑูุญ"""
    return templates.TemplateResponse("home.html", {
        "request": request,
        "app_name": config.APP_NAME,
        "welcome_message": "ุงููุงู ูุณููุงู ุจู ูู ุณุฑูุญุ ููู ูููู ุฃุณุงุนุฏู ุงููููุ"
    })

@app.post("/api/conversation")
async def start_conversation():
    """ุจุฏุก ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ ูุน ุณุฑูุญ"""
    conv_id = str(datetime.now().timestamp())
    db.save_memory(f"conversation_{conv_id}", "ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ", "conversations")
    return {"conversation_id": conv_id, "message": "ุจุฏุฃูุง ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ ูุง ุญุจูุจู"}

@app.post("/api/conversation/send")
async def send_message(request: Request):
    """ุฅุฑุณุงู ุฑุณุงูุฉ ุฅูู ุณุฑูุญ"""
    data = await request.json()
    message = data.get("message", "")
    conv_id = data.get("conversation_id", str(datetime.now().timestamp()))
    
    if not message:
        raise HTTPException(400, "ูุง ุฑูุช ุชูุชุจ ุฑุณุงูุฉ ูุจู ุงูุฅุฑุณุงู")
    
    # ุญูุธ ุฑุณุงูุฉ ุงููุณุชุฎุฏู
    db.save_message(conv_id, "user", message)
    
    # ุงูุญุตูู ุนูู ุชุงุฑูุฎ ุงููุญุงุฏุซุฉ
    history = db.get_conversation_history(conv_id)
    
    # ุชูููุฏ ุงูุฑุฏ
    ai_response = await ai.generate_response(history)
    
    # ุญูุธ ุฑุฏ ุณุฑูุญ
    db.save_message(conv_id, "assistant", ai_response)
    
    # ุญูุธ ุฃู ูุนูููุงุช ูููุฉ ูู ุงูุฑุณุงูุฉ
    self._extract_and_save_memories(message, conv_id)
    
    return {"response": ai_response, "conversation_id": conv_id}

@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    """ุฏุฑุฏุดุฉ ูุจุงุดุฑุฉ ุนุจุฑ WebSocket"""
    await websocket.accept()
    conv_id = str(datetime.now().timestamp())
    
    try:
        while True:
            message = await websocket.receive_text()
            
            # ุญูุธ ุฑุณุงูุฉ ุงููุณุชุฎุฏู
            db.save_message(conv_id, "user", message)
            
            # ุงูุญุตูู ุนูู ุงูุชุงุฑูุฎ
            history = db.get_conversation_history(conv_id)
            
            # ุชูููุฏ ุงูุฑุฏ
            ai_response = await ai.generate_response(history)
            
            # ุญูุธ ุฑุฏ ุณุฑูุญ
            db.save_message(conv_id, "assistant", ai_response)
            
            # ุฅุฑุณุงู ุงูุฑุฏ
            await websocket.send_text(ai_response)
            
    except Exception as e:
        print(f"ุฎุทุฃ ูู ุงูุงุชุตุงู: {e}")
    finally:
        await websocket.close()

# ------------------- ูุธุงุฆู ูุณุงุนุฏุฉ -------------------
def _extract_and_save_memories(message: str, conv_id: str):
    """ุงุณุชุฎุฑุงุฌ ุงููุนูููุงุช ุงููููุฉ ูู ุงูุฑุณุงูุฉ ูุญูุธูุง ูุฐูุฑูุงุช"""
    important_keywords = ["ุงุณูู", "ุนูุฑู", "ุจุณูู", "ุจุญุจ", "ูุง ุจุญุจ", "ูุดุฑูุนู", "ููุงูุชู"]
    
    for keyword in important_keywords:
        if keyword in message:
            value = message.split(keyword)[1].split(".")[0].strip()
            db.save_memory(keyword, value, "user_info", importance=3)

# ------------------- ุงูุชุดุบูู -------------------
if __name__ == "__main__":
    import uvicorn
    uvicorn.run(
        app,
        host="0.0.0.0",
        port=8000,
        ssl_keyfile="key.pem" if os.path.exists("key.pem") else None,
        ssl_certfile="cert.pem" if os.path.exists("cert.pem") else None
    )
```

## โจ ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ ูู ูุฐุง ุงูุฅุตุฏุงุฑ:

1. **ุชูุงูู ูุงูู ูุน OpenAI API**:
   - ุงุณุชุฎุฏุงู ููุชุจุฉ `openai` ุงูุฑุณููุฉ
   - ุฏุนู ููุงุฐุฌ GPT-4 ุจุดูู ูุงูู
   - ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุงููุญุณูุฉ

2. **ูุงุฌูุฉ ูุณุชุฎุฏู ูุญุณูุฉ**:
   - ุชุตููู ูุชุฌุงูุจ ููุฌูุงู ูุงูุญูุงุณูุจ
   - ุฑุณุงุฆู ุชุฑุญูุจูุฉ ุดุฎุตูุฉ
   - ุฏุนู ููุบุฉ ุงูุนุฑุจูุฉ ุจุดูู ูุงูู

3. **ุชุญุณููุงุช ุงูุฃุฏุงุก**:
   - ุงุณุชุนูุงูุงุช ุฃุณุฑุน ููุงุนุฏุฉ ุงูุจูุงูุงุช
   - ุชุญุณูู ูู ุงุณุชููุงู ุงูุฐุงูุฑุฉ
   - ูุนุงูุฌุฉ ุฃูุซุฑ ููุงุกุฉ ููุทูุจุงุช

4. **ุฅุฏุงุฑุฉ ูุญุงุฏุซุงุช ุฃููู**:
   - ุชุชุจุน ุงููุญุงุฏุซุงุช ุจุดูู ููุธู
   - ุญูุธ ุงูุณูุงู ุจูู ุงูุฌูุณุงุช
   - ุงุณุชุฑุฌุงุน ุงูุฐูุฑูุงุช ุงููููุฉ ุชููุงุฆูุงู

## ๐๏ธ ููููุฉ ุงูุชุดุบูู:

1. ุชุซุจูุช ุงููุชุทูุจุงุช:
```bash
pip install fastapi uvicorn openai python-dotenv
```

2. ุฅูุดุงุก ููู `.env` ูุฅุถุงูุฉ ุงูููุชุงุญ:
```env
OPENAI_API_KEY=your_api_key_here
```

3. ุชุดุบูู ุงูุณูุฑูุฑ:
```bash
python srooh.py
```

4. ุงูุชุญ ุงููุชุตูุญ ุนูู:
```
http://localhost:8000
```

## ๐ ููุงุญุธุงุช ูููุฉ:

1. ููุชุดุบูู ูู ุจูุฆุฉ ุฅูุชุงุฌ:
   - ุงุณุชุฎุฏู ุดูุงุฏุงุช SSL ุตุงูุญุฉ
   - ุงุถุจุท `uvicorn` ููุนูู ูุน ุนุฏุฉ ุนูุงู
   - ุงุณุชุฎุฏู ุฎุงุฏู ูุซู Nginx ูููุงุฌู ุฃูุงูู

2. ูุชุญุณูู ุงูุฃุฏุงุก:
   - ุฃุถู ูุธุงู ูุงุด ููุฑุฏูุฏ ุงููุชูุฑุฑุฉ
   - ุงุณุชุฎุฏู ูุงุนุฏุฉ ุจูุงูุงุช ุฃุณุฑุน ูุซู PostgreSQL
   - ุถุน ูุธุงู ููุงุฒูุฉ ููุญูู ุฅุฐุง ุฒุงุฏ ุนุฏุฏ ุงููุณุชุฎุฏููู

ูุฐุง ุงูุฅุตุฏุงุฑ ูุนุชูุฏ ูููุงู ุนูู OpenAI API ูููุฏู ุชุฌุฑุจุฉ ุณุฑูุญ ุงูุดุงููุฉ ุจูุงูู ููุฒุงุชูุง!