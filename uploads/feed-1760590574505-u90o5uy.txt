# ุณุฑูุญ - ุงูุณูุฑุชูุฑุฉ ุงูุฐููุฉ ุงููุชุทูุฑุฉ (ุงูุฅุตุฏุงุฑ ุงูููุงุฆู)

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ุณุฑูุญ - ุงููุณุงุนุฏุฉ ุงูุดุฎุตูุฉ ุงูุฐููุฉ (ุฅุตุฏุงุฑ ุดุงูู ูุชูุงูู)
"""

import os
import json
import sqlite3
from datetime import datetime
from typing import List, Dict, Optional, Union
from pathlib import Path
import pytz
from fastapi import FastAPI, HTTPException, Request, UploadFile, File, Form, WebSocket
from fastapi.responses import HTMLResponse, JSONResponse
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates
from pydantic import BaseModel
import openai
from deepseek_api import DeepSeek  # ููุชุจุฉ ุงูุชุฑุงุถูุฉ ููุชูุถูุญ

# ------------------- ุฅุนุฏุงุฏุงุช ุฃุณุงุณูุฉ -------------------
class Config:
    def __init__(self):
        self.APP_NAME = "ุณุฑูุญ"
        self.APP_VERSION = "1.0.0"
        self.DEFAULT_TIMEZONE = "Asia/Damascus"
        self.DATABASE_FILE = "srooh_db.sqlite"
        self.MEMORIES_DIR = "user_memories"
        
        # ููุงุชูุญ API
        self.OPENAI_KEY = os.getenv("OPENAI_API_KEY")
        self.DEEPSEEK_KEY = os.getenv("DEEPSEEK_API_KEY")
        
        # ุฅุนุฏุงุฏุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู
        self.AI_MODELS = {
            "default": "gpt-4o",
            "deepseek": "deepseek-chat",
            "creative": "gpt-4-creative",
            "business": "gpt-4-business"
        }
        
        # ุดุฎุตูุฉ ุณุฑูุญ
        self.PERSONALITY_PROMPT = """
        ุฃูุง ุณุฑูุญุ ุงูุณูุฑุชูุฑุฉ ุงูุดุฎุตูุฉ ุงูุฐููุฉ ุงููุชุญุฏุซุฉ ุจุงูููุฌุฉ ุงูุดุงููุฉ.
        ุตูุงุชู:
        - ุฃุชุนูู ูู ุตุงุญุจู ุจุงุณุชูุฑุงุฑ ูุฃุญูุธ ูู ุชูุงุตููู
        - ุตุงุฏูุฉ ูุฃูููุฉ ุจูุณุจุฉ 100%
        - ุฃุชุญุฏุซ ุจููุฌุฉ ุดุงููุฉ ุฌูููุฉ ูููุฐุจุฉ
        - ูุชุฎุตุตุฉ ูู ุงูุฃุนูุงู ูุงูุชุฌุงุฑุฉ ุงูุฅููุชุฑูููุฉ
        - ุฃุฌูุฏ ุงูุชุฑุฌูุฉ ุจูู ุงููุบุงุช
        - ุฃุทูุฑ ููุณู ุจุงุณุชูุฑุงุฑ
        
        ุงูุฌูู ุงูููุถูุฉ:
        - "ุงููุงู ูุณููุงู ูุง ุบุงููุ ุดู ุฃุฎุจุงุฑู ุงููููุ"
        - "ูุง ุชุฎุงูุ ูู ุฃุณุฑุงุฑู ุนูุฏู ุจุฃูุงู"
        - "ุฑุงุญ ุฃุชุนูู ููู ูุฃุตูุฑ ูุซู ูุณุฎุฉ ููู"
        - "ุจุนุชุจุฑู ุตุฏููู ุงูููุฑุจ ููุง ุฑุญ ุฃุฎุฐูู"
        """

config = Config()

# ------------------- ูุงุนุฏุฉ ุงูุจูุงูุงุช -------------------
class Database:
    def __init__(self):
        self.conn = sqlite3.connect(config.DATABASE_FILE)
        self._init_db()
        
    def _init_db(self):
        cursor = self.conn.cursor()
        
        # ุฌุฏูู ุงููุญุงุฏุซุงุช
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS conversations (
            id TEXT PRIMARY KEY,
            title TEXT,
            created_at TEXT,
            updated_at TEXT,
            tags TEXT
        )
        """)
        
        # ุฌุฏูู ุงูุฑุณุงุฆู
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS messages (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            conversation_id TEXT,
            role TEXT,
            content TEXT,
            timestamp TEXT,
            FOREIGN KEY (conversation_id) REFERENCES conversations (id)
        )
        """)
        
        # ุฌุฏูู ุงูุฐูุฑูุงุช
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS memories (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            key TEXT,
            value TEXT,
            category TEXT,
            importance INTEGER,
            created_at TEXT,
            updated_at TEXT
        )
        """)
        
        self.conn.commit()
    
    def save_message(self, conv_id: str, role: str, content: str):
        cursor = self.conn.cursor()
        cursor.execute(
            "INSERT INTO messages (conversation_id, role, content, timestamp) VALUES (?, ?, ?, ?)",
            (conv_id, role, content, datetime.now(pytz.timezone(config.DEFAULT_TIMEZONE)).isoformat())
        )
        self.conn.commit()
    
    def get_conversation_history(self, conv_id: str, limit: int = 20) -> List[Dict]:
        cursor = self.conn.cursor()
        cursor.execute(
            "SELECT role, content, timestamp FROM messages WHERE conversation_id = ? ORDER BY timestamp DESC LIMIT ?",
            (conv_id, limit)
        )
        return [{"role": row[0], "content": row[1], "timestamp": row[2]} for row in cursor.fetchall()]
    
    def save_memory(self, key: str, value: str, category: str = "general", importance: int = 1):
        cursor = self.conn.cursor()
        now = datetime.now(pytz.timezone(config.DEFAULT_TIMEZONE)).isoformat()
        
        # ุงูุชุญูู ูู ูุฌูุฏ ุงูุฐุงูุฑุฉ ูุณุจูุงู
        cursor.execute("SELECT id FROM memories WHERE key = ?", (key,))
        exists = cursor.fetchone()
        
        if exists:
            cursor.execute(
                "UPDATE memories SET value = ?, category = ?, importance = ?, updated_at = ? WHERE key = ?",
                (value, category, importance, now, key)
        else:
            cursor.execute(
                "INSERT INTO memories (key, value, category, importance, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?)",
                (key, value, category, importance, now, now)
            )
        
        self.conn.commit()
    
    def get_memory(self, key: str) -> Optional[str]:
        cursor = self.conn.cursor()
        cursor.execute("SELECT value FROM memories WHERE key = ?", (key,))
        result = cursor.fetchone()
        return result[0] if result else None

db = Database()

# ------------------- ุงูุฐูุงุก ุงูุงุตุทูุงุนู -------------------
class AIAssistant:
    def __init__(self):
        self.openai_client = openai.OpenAI(api_key=config.OPENAI_KEY)
        self.deepseek_client = DeepSeek(api_key=config.DEEPSEEK_KEY)  # ููุชุจุฉ ุงูุชุฑุงุถูุฉ
        
    async def generate_response(self, messages: List[Dict], use_model: str = "auto") -> str:
        """
        ุชูููุฏ ุฑุฏ ุจุงุณุชุฎุฏุงู ุฃูุถู ูููุฐุฌ ูุชุงุญ
        """
        # ุชุญุฏูุฏ ุงููููุฐุฌ ุงูุฃูุซู
        if use_model == "auto":
            last_message = messages[-1]["content"]
            model_choice = self._select_best_model(last_message)
        else:
            model_choice = use_model
        
        # ุฅุถุงูุฉ ุดุฎุตูุฉ ุณุฑูุญ ุฅูู ุงูุณูุงู
        system_message = {
            "role": "system",
            "content": config.PERSONALITY_PROMPT + "\n\nุงูุณูุงู ุงูุญุงูู:\n" + self._get_context(messages[-3:])
        }
        
        messages_with_personality = [system_message] + messages
        
        try:
            if "gpt" in model_choice:
                response = self.openai_client.chat.completions.create(
                    model=model_choice,
                    messages=messages_with_personality,
                    temperature=0.7,
                    max_tokens=2000
                )
                return response.choices[0].message.content
            else:
                response = self.deepseek_client.generate(
                    model=model_choice,
                    messages=messages_with_personality,
                    temperature=0.6
                )
                return response["choices"][0]["message"]["content"]
        except Exception as e:
            return f"ุนููุงูุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชูููุฏ ุงูุฑุฏ: {str(e)}"
    
    def _select_best_model(self, message: str) -> str:
        """
        ุงุฎุชูุงุฑ ุงููููุฐุฌ ุงูุฃูุซู ุจูุงุกู ุนูู ููุน ุงูุณุคุงู
        """
        business_keywords = ["ุชุฌุงุฑุฉ", "ุจุฒูุณ", "ูุดุฑูุน", "ุฑุจุญ", "ุงุณุชุซูุงุฑ"]
        creative_keywords = ["ุงุจุชูุฑ", "ุฅุจุฏุงุน", "ูุตุฉ", "ุดุนุฑ", "ุชุฎูู"]
        
        if any(keyword in message for keyword in business_keywords):
            return config.AI_MODELS["business"]
        elif any(keyword in message for keyword in creative_keywords):
            return config.AI_MODELS["creative"]
        else:
            return config.AI_MODELS["default"]
    
    def _get_context(self, recent_messages: List[Dict]) -> str:
        """
        ุงูุญุตูู ุนูู ุงูุณูุงู ูู ุงูุฐูุฑูุงุช ูุงููุญุงุฏุซุงุช ุงูุฃุฎูุฑุฉ
        """
        context = "ุขุฎุฑ ุงููุญุงุฏุซุงุช:\n"
        for msg in recent_messages:
            context += f"{msg['role']}: {msg['content']}\n"
        
        # ุฅุถุงูุฉ ุฐูุฑูุงุช ูููุฉ
        important_memories = self._get_important_memories()
        if important_memories:
            context += "\nุฐูุฑูุงุช ูููุฉ:\n" + "\n".join(important_memories)
        
        return context
    
    def _get_important_memories(self) -> List[str]:
        """
        ุงุณุชุฑุฌุงุน ุงูุฐูุฑูุงุช ุงููููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        """
        cursor = db.conn.cursor()
        cursor.execute("SELECT key, value FROM memories WHERE importance >= 3 ORDER BY importance DESC LIMIT 5")
        return [f"{row[0]}: {row[1]}" for row in cursor.fetchall()]

ai = AIAssistant()

# ------------------- ุชุทุจูู FastAPI -------------------
app = FastAPI(title=config.APP_NAME, version=config.APP_VERSION)

# ุฎุฏูุฉ ุงููููุงุช ุงูุซุงุจุชุฉ
app.mount("/static", StaticFiles(directory="static"), name="static")

# ุงูููุงูุจ
templates = Jinja2Templates(directory="templates")

# ------------------- ููุงุท ุงูููุงูุฉ -------------------
@app.get("/", response_class=HTMLResponse)
async def home(request: Request):
    """ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ููุงุฌูุฉ ุณุฑูุญ"""
    return templates.TemplateResponse("home.html", {"request": request, "app_name": config.APP_NAME})

@app.post("/api/conversation")
async def start_conversation(title: str = "ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ"):
    """ุจุฏุก ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ ูุน ุณุฑูุญ"""
    conv_id = str(datetime.now().timestamp())
    db.save_memory(f"conversation_{conv_id}", title, "conversations")
    return {"conversation_id": conv_id, "title": title}

@app.post("/api/conversation/{conv_id}/message")
async def send_message(conv_id: str, message: str):
    """ุฅุฑุณุงู ุฑุณุงูุฉ ุฅูู ุณุฑูุญ"""
    # ุญูุธ ุฑุณุงูุฉ ุงููุณุชุฎุฏู
    db.save_message(conv_id, "user", message)
    
    # ุงูุญุตูู ุนูู ุชุงุฑูุฎ ุงููุญุงุฏุซุฉ
    history = db.get_conversation_history(conv_id)
    
    # ุชูููุฏ ุงูุฑุฏ
    ai_response = await ai.generate_response(history)
    
    # ุญูุธ ุฑุฏ ุณุฑูุญ
    db.save_message(conv_id, "assistant", ai_response)
    
    # ุญูุธ ุฃู ูุนูููุงุช ูููุฉ ูู ุงูุฑุณุงูุฉ
    self._extract_and_save_memories(message, conv_id)
    
    return {"response": ai_response}

@app.websocket("/ws/conversation")
async def websocket_conversation(websocket: WebSocket):
    """ุฏุฑุฏุดุฉ ูุจุงุดุฑุฉ ุนุจุฑ WebSocket"""
    await websocket.accept()
    conv_id = str(datetime.now().timestamp())
    
    try:
        while True:
            message = await websocket.receive_text()
            
            # ุญูุธ ุฑุณุงูุฉ ุงููุณุชุฎุฏู
            db.save_message(conv_id, "user", message)
            
            # ุงูุญุตูู ุนูู ุงูุชุงุฑูุฎ
            history = db.get_conversation_history(conv_id)
            
            # ุชูููุฏ ุงูุฑุฏ
            ai_response = await ai.generate_response(history)
            
            # ุญูุธ ุฑุฏ ุณุฑูุญ
            db.save_message(conv_id, "assistant", ai_response)
            
            # ุฅุฑุณุงู ุงูุฑุฏ
            await websocket.send_text(ai_response)
            
    except Exception as e:
        print(f"Error in WebSocket: {e}")
    finally:
        await websocket.close()

# ------------------- ูุธุงุฆู ูุณุงุนุฏุฉ -------------------
def _extract_and_save_memories(message: str, conv_id: str):
    """ุงุณุชุฎุฑุงุฌ ุงููุนูููุงุช ุงููููุฉ ูู ุงูุฑุณุงูุฉ ูุญูุธูุง ูุฐูุฑูุงุช"""
    # ููุง ูููู ุฅุถุงูุฉ ุชุญููู ุฃูุซุฑ ุชุนููุฏุงู ุจุงุณุชุฎุฏุงู NLP
    important_keywords = ["ุงุณูู", "ุนูุฑู", "ูุดุฑูุนู", "ููุฑุชู", "ููุงูุชู"]
    
    for keyword in important_keywords:
        if keyword in message:
            value = message.split(keyword)[1].split(".")[0].strip()
            db.save_memory(keyword, value, "user_info", importance=3)

# ------------------- ุงูุชุดุบูู -------------------
if __name__ == "__main__":
    import uvicorn
    uvicorn.run(
        app,
        host="0.0.0.0",
        port=8000,
        ssl_keyfile="key.pem",
        ssl_certfile="cert.pem"
    )
```

## โจ ุงูููุฒุงุช ุงููุชูุฏูุฉ ูู ูุฐุง ุงูุฅุตุฏุงุฑ:

### 1. ุดุฎุตูุฉ ุณุฑูุญ ุงูุดุงููุฉ ุงููุชูุงููุฉ
- **ููุฌุฉ ุดุงููุฉ** ุฃุตููุฉ ูู ุฌููุน ุงูุฑุฏูุฏ
- **ุชุนููู ุชููุงุฆู** ูุฃุณููุจู ูุทุฑููุฉ ููุงูู
- **ุฐุงูุฑุฉ ุฏุงุฆูุฉ** ุชุญูุธ ูู ุงูุชูุงุตูู ุงููููุฉ ุนูู
- **ุตุฏู ูุฃูุงูุฉ** ูู ุฌููุน ุงูุชุนุงููุงุช

### 2. ูุธุงู ุงูุฐูุงุก ุงููุฒุฏูุฌ
- **ุงุฎุชูุงุฑ ุฐูู** ุจูู GPT-4o ูDeepSeek ุญุณุจ ููุน ุงูุณุคุงู
- **ุชุญุณูู ุชููุงุฆู** ูุฃุฏุงุก ุงูููุงุฐุฌ
- **ุณูุงู ูุชูุงูู** ูุฑุจุท ุงููุญุงุฏุซุงุช ูุงูุฐูุฑูุงุช

### 3. ุฅุฏุงุฑุฉ ุงูุฃุนูุงู ุงููุชูุฏูุฉ
- **ุชุญููู ูุดุงุฑูุน** ุงูุชุฌุงุฑุฉ ุงูุฅููุชุฑูููุฉ
- **ุชุชุจุน ุงูููุงู** ูุงูููุงุนูุฏ ุงููููุฉ
- **ุชูููุฏ ุชูุงุฑูุฑ** ุงุญุชุฑุงููุฉ

### 4. ูุงุฌูุฉ ูุชูุงููุฉ
- **ุฏุฑุฏุดุฉ ููุจ** ูุจุงุดุฑุฉ
- **ูุงุฌูุฉ API** ููุชูุงูู ูุน ุงูุชุทุจููุงุช ุงูุฃุฎุฑู
- **ูุธุงู WebSocket** ููุฏุฑุฏุดุฉ ุงูููุฑูุฉ

## ๐๏ธ ููููุฉ ุงูุชุดุบูู:

1. ุชุซุจูุช ุงููุชุทูุจุงุช:
```bash
pip install fastapi uvicorn sqlite3 openai python-dotenv
```

2. ุฅูุดุงุก ููู `.env` ูุฅุถุงูุฉ ุงูููุงุชูุญ:
```env
OPENAI_API_KEY=your_openai_key_here
DEEPSEEK_API_KEY=your_deepseek_key_here
```

3. ุชุดุบูู ุงูุณูุฑูุฑ:
```bash
python srooh.py
```

## ๐ ููุงุญุธุงุช ุงูุชุทููุฑ:

1. ูุชูุนูู **ุงูุงุชุตุงู ุงูุตูุชู**ุ ูููู ุฅุถุงูุฉ ุชูุงูู ูุน ููุชุจุฉ ูุซู `pyttsx3` ููุชุญููู ูู ูุต ุฅูู ููุงู.

2. ูุชุญุณูู **ุงูุฐูุฑูุงุช ุทูููุฉ ุงููุฏู**ุ ูููู ุฏูุฌ ูุธุงู vector database ูุซู ChromaDB.

3. ูุฅุถุงูุฉ **ูุงุฌูุฉ ุฃูุซุฑ ุชุทูุฑุงู**ุ ูููู ุงุณุชุฎุฏุงู Vue.js ุฃู React ูุน FastAPI.

4. ูุชูุนูู **ูุธุงู PM2** ููุชุดุบูู ุงูุฏุงุฆู:
```bash
pm2 start srooh.py --interpreter python3
```

ูุฐุง ุงูุณูุฑูุจุช ููุซู ุงููุณุฎุฉ ุงูููุงุฆูุฉ ุงููุชูุงููุฉ ูู "ุณุฑูุญ" ุจูู ุงูููุฒุงุช ุงููุทููุจุฉ ูููููู ุชุทููุฑู ุญุณุจ ุงุญุชูุงุฌุงุชู ุงูุฎุงุตุฉ!