"""
ğŸ§  Surooh Core - Core Dispatcher
Ù†ÙˆØ§Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹ - Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ ÙˆØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù‡Ø§Ù…
"""

from typing import Dict, Optional, Any
from loguru import logger

try:
    from .delegation import delegation
except ImportError:
    from delegation import delegation

class CoreDispatcher:
    """Ù†ÙˆØ§Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹ - Ø¹Ù‚Ù„ Ø§Ù„ØªÙ†ÙÙŠØ° Ù„Ø³ÙØ±ÙˆØ­"""
    
    def __init__(self):
        self.delegation = delegation
        
        # Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ù‡Ø§Ù… â†’ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± â†’ Ø§Ù„Ø¨ÙˆØªØ§Øª
        self.task_to_role_map = {
            # Ù…Ù‡Ø§Ù… Ø¯Ø¹Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
            "handle_inquiry": "customer_support",
            "create_ticket": "customer_support",
            "check_order_status": "customer_support",
            "process_refund": "customer_support",
            
            # Ù…Ù‡Ø§Ù… Ø§Ù„ØªØ³Ø¹ÙŠØ±
            "analyze_pricing": "pricing_analyst",
            "generate_quote": "pricing_analyst",
            "compare_competitors": "pricing_analyst",
            "update_price_list": "pricing_analyst",
            
            # Ù…Ù‡Ø§Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
            "generate_report": "analytics_engine",
            "analyze_trends": "analytics_engine",
            "predict_demand": "analytics_engine",
            "calculate_metrics": "analytics_engine",
            
            # Ù…Ù‡Ø§Ù… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            "process_order": "order_processor",
            "update_inventory": "order_processor",
            "generate_invoice": "order_processor",
            "track_shipment": "order_processor",
        }
        
        # Ø§Ù„Ø¨ÙˆØªØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© (ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø§Ø­Ù‚Ø§Ù‹)
        self.available_bots = {
            "customer_support": {
                "name": "Ø¨ÙˆØª Ø¯Ø¹Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡",
                "status": "active",
                "endpoint": "/api/bots/customer-support"
            },
            "pricing_analyst": {
                "name": "Ø¨ÙˆØª ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ³Ø¹ÙŠØ±",
                "status": "active",
                "endpoint": "/api/bots/pricing-analyst"
            },
            "analytics_engine": {
                "name": "Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª",
                "status": "active",
                "endpoint": "/api/bots/analytics-engine"
            },
            "order_processor": {
                "name": "Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø·Ù„Ø¨Ø§Øª",
                "status": "active",
                "endpoint": "/api/bots/order-processor"
            }
        }
        
        logger.info("ğŸ§  Core Dispatcher initialized - Execution brain ready")
    
    def dispatch_task(self, task: str, payload: Optional[Dict[str, Any]] = None) -> Dict:
        """
        ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù„Ø¨ÙˆØª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
        
        Args:
            task: Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªÙ†ÙÙŠØ°Ù‡Ø§
            payload: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ§Ø­Ø¨Ø© Ù„Ù„Ù…Ù‡Ù…Ø©
        
        Returns:
            Dict: Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªÙ†ÙÙŠØ°
        """
        payload = payload or {}
        
        logger.info(f"ğŸ“¥ Dispatching task: {task}")
        
        # 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…Ù‡Ù…Ø©
        role = self.task_to_role_map.get(task)
        
        if not role:
            logger.warning(f"âš ï¸ Unknown task: {task}")
            return {
                "success": False,
                "error": f"Ù…Ù‡Ù…Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©: {task}",
                "task": task
            }
        
        logger.info(f"ğŸ¯ Task '{task}' mapped to role: {role}")
        
        # 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        permission_check = self.delegation.check_permission(role, task)
        
        if not permission_check["allowed"]:
            logger.warning(f"ğŸš« Permission denied: {permission_check['reason']}")
            return {
                "success": False,
                "error": permission_check["reason"],
                "requires_approval": permission_check["requires_approval"],
                "task": task,
                "role": role
            }
        
        logger.info(f"âœ… Permission granted: {permission_check['reason']}")
        
        # 3. Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
        bot = self.available_bots.get(role)
        
        if not bot:
            logger.error(f"âŒ No bot available for role: {role}")
            return {
                "success": False,
                "error": f"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙˆØª Ù…ØªØ§Ø­ Ù„Ù„Ø¯ÙˆØ±: {role}",
                "task": task,
                "role": role
            }
        
        if bot["status"] != "active":
            logger.error(f"âŒ Bot is not active: {bot['name']}")
            return {
                "success": False,
                "error": f"Ø§Ù„Ø¨ÙˆØª ØºÙŠØ± Ù†Ø´Ø·: {bot['name']}",
                "task": task,
                "bot": bot["name"]
            }
        
        logger.info(f"ğŸ¤– Selected bot: {bot['name']} ({bot['endpoint']})")
        
        # 4. ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù‡Ù…Ø© (Ù…Ø­Ø§ÙƒØ§Ø© - ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø­Ù‚ÙŠÙ‚ÙŠ)
        result = self._execute_task(bot, task, payload)
        
        logger.info(f"âœ… Task '{task}' executed successfully by {bot['name']}")
        
        return result
    
    def _execute_task(self, bot: Dict, task: str, payload: Dict) -> Dict:
        """
        ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù‡Ù…Ø© (Ù…Ø­Ø§ÙƒØ§Ø©)
        ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ØŒ Ù‡Ù†Ø§ ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¨ÙˆØª Ø§Ù„ÙØ¹Ù„ÙŠ
        """
        
        # Ù…Ø­Ø§ÙƒØ§Ø© ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù‡Ù…Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹Ù‡Ø§
        mock_results = {
            "handle_inquiry": {
                "response": "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ø³ØªÙØ³Ø§Ø±Ùƒ ÙˆØ³ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹",
                "ticket_id": "TKT-2025-001"
            },
            "analyze_pricing": {
                "analysis": "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙŠØ´ÙŠØ± Ø¥Ù„Ù‰ ÙØ±ØµØ© ØªÙ†Ø§ÙØ³ÙŠØ© ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚",
                "recommended_price": 150.00,
                "confidence": 0.87
            },
            "generate_report": {
                "report_id": "RPT-2025-001",
                "summary": "ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠ - Ø£ÙƒØªÙˆØ¨Ø± 2025",
                "metrics": {
                    "total_sales": 125000,
                    "growth_rate": 15.5
                }
            },
            "process_order": {
                "order_id": "ORD-2025-001",
                "status": "processed",
                "invoice_generated": True
            }
        }
        
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø© Ù…Ø­Ø§ÙƒØ§Ø© Ø£Ùˆ Ù†ØªÙŠØ¬Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        mock_result = mock_results.get(task, {
            "message": f"ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù‡Ù…Ø© {task} Ø¨Ù†Ø¬Ø§Ø­",
            "data": payload
        })
        
        return {
            "success": True,
            "task": task,
            "bot": bot["name"],
            "bot_endpoint": bot["endpoint"],
            "result": mock_result,
            "timestamp": "2025-10-16T22:20:00Z"
        }
    
    def get_available_tasks(self) -> list:
        """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©"""
        return list(self.task_to_role_map.keys())
    
    def get_bot_status(self, role: str) -> Optional[Dict]:
        """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø¨ÙˆØª Ù…Ø¹ÙŠÙ†"""
        return self.available_bots.get(role)
    
    def health_check(self) -> Dict:
        """ÙØ­Øµ ØµØ­Ø© Ø§Ù„Ù†Ø¸Ø§Ù…"""
        active_bots = sum(1 for bot in self.available_bots.values() if bot["status"] == "active")
        
        return {
            "status": "healthy",
            "dispatcher": "operational",
            "delegation": "loaded",
            "total_bots": len(self.available_bots),
            "active_bots": active_bots,
            "available_tasks": len(self.task_to_role_map),
            "roles": self.delegation.get_all_roles()
        }


# ğŸŒ Ù†Ø³Ø®Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ø§Ù„Ù…ÙŠØ©
dispatcher = CoreDispatcher()
