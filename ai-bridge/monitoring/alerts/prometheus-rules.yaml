groups:
  - name: ai_bridge_critical
    interval: 30s
    rules:
      - alert: BridgeDown
        expr: up{job="ai-bridge"} == 0
        for: 1m
        labels:
          severity: critical
          component: bridge
        annotations:
          summary: "AI Bridge is down"
          description: "The AI Bridge service at {{ $labels.instance }} has been down for more than 1 minute"
          action: "Check systemctl status surooh-ai-bridge and review logs"
      
      - alert: AllProvidersDown
        expr: sum(bridge_provider_availability) == 0
        for: 2m
        labels:
          severity: critical
          component: providers
        annotations:
          summary: "All AI providers are down"
          description: "No AI providers are available"
          action: "Check API keys and provider status pages"

  - name: ai_bridge_warnings
    interval: 1m
    rules:
      - alert: HighLatency
        expr: bridge_request_duration_seconds_avg > 5
        for: 5m
        labels:
          severity: warning
          component: performance
        annotations:
          summary: "High average latency detected"
          description: "Average request latency for {{ $labels.provider }} on {{ $labels.task_type }} is {{ $value }}s (threshold: 5s)"
          action: "Review provider performance and consider switching primary provider"
      
      - alert: ProviderDown
        expr: bridge_provider_availability{provider=~"openai|llama|mistral|claude"} == 0
        for: 2m
        labels:
          severity: warning
          component: providers
        annotations:
          summary: "AI Provider {{ $labels.provider }} is down"
          description: "Provider {{ $labels.provider }} has been unavailable for 2 minutes"
          action: "Check API key validity and provider status"
      
      - alert: HighErrorRate
        expr: |
          sum(rate(bridge_requests_total{status="error"}[5m])) 
          / 
          sum(rate(bridge_requests_total[5m])) > 0.1
        for: 3m
        labels:
          severity: warning
          component: reliability
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} over the last 5 minutes"
          action: "Review error logs and provider status"
      
      - alert: P99LatencyHigh
        expr: bridge_request_duration_seconds_p99 > 10
        for: 5m
        labels:
          severity: warning
          component: performance
        annotations:
          summary: "P99 latency is high"
          description: "P99 latency for {{ $labels.provider }} is {{ $value }}s"
          action: "Consider scaling or provider optimization"

  - name: ai_bridge_info
    interval: 5m
    rules:
      - alert: FrequentCommittee
        expr: rate(bridge_committee_triggers_total[10m]) > 0.5
        for: 5m
        labels:
          severity: info
          component: committee
        annotations:
          summary: "Frequent committee mode activation"
          description: "Committee mode triggered {{ $value }} times per minute over last 10 minutes"
          action: "Review sensitive task classification and confidence thresholds"
      
      - alert: LowRequestVolume
        expr: rate(bridge_requests_total[5m]) < 0.01
        for: 10m
        labels:
          severity: info
          component: usage
        annotations:
          summary: "Low request volume"
          description: "Request rate is {{ $value }} req/s (very low)"
          action: "Verify Nucleus integration is sending requests"
      
      - alert: HighRequestVolume
        expr: rate(bridge_requests_total[5m]) > 10
        for: 5m
        labels:
          severity: info
          component: usage
        annotations:
          summary: "High request volume"
          description: "Request rate is {{ $value }} req/s (consider scaling)"
          action: "Monitor resource usage and consider horizontal scaling"
      
      - alert: UnbalancedRouting
        expr: |
          max(sum(rate(bridge_requests_total[10m])) by (provider)) 
          / 
          min(sum(rate(bridge_requests_total[10m])) by (provider)) > 5
        for: 10m
        labels:
          severity: info
          component: routing
        annotations:
          summary: "Unbalanced provider routing"
          description: "Provider usage distribution is heavily skewed"
          action: "Review routing weights in routing_policies.yaml"

  - name: ai_bridge_capacity
    interval: 2m
    rules:
      - alert: NearRateLimit
        expr: |
          sum(rate(bridge_requests_total[1m])) * 60 > 18
        for: 2m
        labels:
          severity: warning
          component: capacity
        annotations:
          summary: "Approaching rate limit"
          description: "Request rate is {{ $value }} req/min (limit: 20 req/min)"
          action: "Consider increasing NGINX rate limit or scaling"
      
      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes > 500000000
        for: 5m
        labels:
          severity: warning
          component: resources
        annotations:
          summary: "High memory usage"
          description: "Bridge process using {{ $value | humanize }}B of memory"
          action: "Monitor for memory leaks and consider restart"

  - name: ai_bridge_sla
    interval: 5m
    rules:
      - alert: SLAViolation
        expr: |
          sum(rate(bridge_requests_total{status="success"}[10m])) 
          / 
          sum(rate(bridge_requests_total[10m])) < 0.95
        for: 10m
        labels:
          severity: critical
          component: sla
        annotations:
          summary: "SLA violation: Success rate below 95%"
          description: "Success rate is {{ $value | humanizePercentage }} (SLA: 95%)"
          action: "Investigate provider failures and error patterns"
      
      - alert: LatencySLAViolation
        expr: bridge_request_duration_seconds_p95 > 3
        for: 10m
        labels:
          severity: warning
          component: sla
        annotations:
          summary: "SLA violation: P95 latency above 3s"
          description: "P95 latency is {{ $value }}s (SLA: 3s)"
          action: "Optimize provider selection or increase timeout"
